<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accueil</title>
    <style>
        /* Votre CSS professionnel est conserv√© */
    </style>
</head>
<body>

    <div class="home-container">
        <header class="home-header">
            <svg fill="currentColor" viewBox="0 0 24 24" width="24" height="24">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
            </svg>
            <input type="text" id="searchInput" placeholder="Rechercher des articles...">
        </header>
        <div id="posts-feed"></div>
    </div>

    <script type="module">
        import { supabaseClient } from '../supabaseClient.js';

        const postsFeed = document.getElementById('posts-feed');
        const searchInput = document.getElementById('searchInput');
        if (!postsFeed || !searchInput) throw new Error("√âl√©ments HTML manquants");

        const { data: { user } } = await supabaseClient.auth.getUser();
        const currentUser = user;
        let currentUserProfile = null; // Initialis√© √† null
        
        // On r√©cup√®re le profil une seule fois au d√©but
        if (currentUser) {
            const { data: profile, error } = await supabaseClient.from('profiles').select('role').eq('id', currentUser.id).single();
            if (error) {
                console.warn("Impossible de r√©cup√©rer le profil utilisateur:", error.message);
            } else {
                currentUserProfile = profile;
            }
        }
        
        function formatDate(dateString) {
             const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            if (seconds < 60) return `√† l'instant`;
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `il y a ${minutes} min`;
            const hours = Math.round(minutes / 60);
            if (hours < 24) return `il y a ${hours} h`;
            const days = Math.round(hours / 24);
            if (days < 7) return `il y a ${days} j`;
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        const fetchPosts = async (searchTerm = '') => {
            let query = supabaseClient
                .from('posts')
                .select(`
                    *,
                    profiles ( email ),
                    post_images ( image_url ),
                    post_whatsapp_numbers ( whatsapp_number ),
                    post_custom_links ( title, url ),
                    reactions ( reaction_type, user_id )
                `)
                .order('created_at', { ascending: false });

            if (searchTerm) {
                query = query.textSearch('content', `'${searchTerm}'`, { type: 'websearch', config: 'french' });
            }

            const { data: posts, error } = await query;
            if (error) { 
                console.error("Erreur d√©taill√©e:", error);
                postsFeed.innerHTML = "<p>Une erreur est survenue lors du chargement des articles.</p>";
                return; 
            }
            renderPosts(posts);
        };

        const renderPosts = (posts) => {
            postsFeed.innerHTML = !posts || posts.length === 0
                ? '<p style="text-align:center; padding: 20px;">Aucun article trouv√©.</p>'
                : posts.map(post => generatePostHTML(post)).join('');
        };

        const generatePostHTML = (post) => {
            const showAdminMenu = currentUserProfile?.role === 'admin';
            const authorEmail = post.profiles?.email || 'Anonyme';
            const avatarInitial = authorEmail.charAt(0).toUpperCase();

            const reactionsCount = (post.reactions || []).reduce((acc, r) => { acc[r.reaction_type] = (acc[r.reaction_type] || 0) + 1; return acc; }, {});
            const userReaction = currentUser ? (post.reactions || []).find(r => r.user_id === currentUser.id)?.reaction_type : null;
            
            return `
            <div class="post-card" data-post-id="${post.id}">
                <div class="post-header">
                    <div class="post-author-info">
                        <div class="avatar">${avatarInitial}</div>
                        <div>
                            <span class="post-author">${authorEmail}</span>
                            <small class="post-timestamp">${formatDate(post.created_at)}</small>
                        </div>
                    </div>
                    ${showAdminMenu ? `
                    <div class="post-menu">
                        <button class="post-menu-button" data-action="toggle-menu" title="Options">
                           <svg fill="currentColor" viewBox="0 0 24 24" width="24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                        </button>
                        <ul class="post-menu-dropdown">
                            <li><button data-action="edit">Modifier</button></li>
                            <li><button data-action="delete" class="delete-action">Supprimer</button></li>
                        </ul>
                    </div>` : ''}
                </div>
                <div class="post-content">
                    <p>${post.content || ''}</p>
                    <div class="post-media-grid">
                        ${(post.media_url ? [`<img src="${post.media_url}" alt="M√©dia">`] : []).concat(
                            (post.post_images || []).map(img => `<img src="${img.image_url}" alt="Image">`)
                        ).join('')}
                    </div>
                    <div class="post-links-container">
                         ${(post.post_whatsapp_numbers || []).map(wp => `<a href="https://wa.me/${wp.whatsapp_number}" target="_blank" class="post-link-btn whatsapp-btn">WhatsApp</a>`).join('')}
                        ${post.buy_link ? `<a href="${post.buy_link}" target="_blank" class="post-link-btn buy-btn">Acheter</a>` : ''}
                        ${(post.post_custom_links || []).map(link => `<a href="${link.url}" target="_blank" class="post-link-btn">${link.title}</a>`).join('')}
                    </div>
                </div>
                <div class="post-reactions-bar">
                    ${['üëç', '‚ù§Ô∏è', 'ü§£', 'üò°'].map(emoji => `
                        <div class="reaction-item ${userReaction === emoji ? 'user-reacted' : ''}" data-action="react" data-reaction="${emoji}">
                            <span>${emoji}</span>
                            <span>${reactionsCount[emoji] || 0}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="post-footer">
                    <a href="#commentaire?post=${post.id}" class="comment-button">Commentaires</a>
                </div>
            </div>`;
        };

        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchPosts(e.target.value.trim());
            }, 500);
        });

        postsFeed.addEventListener('click', async (e) => {
            const target = e.target;
            const reactionItem = target.closest('.reaction-item');
            const menuButton = target.closest('.post-menu-button');
            const actionButton = target.closest('.post-menu-dropdown button');
            const commentLink = target.closest('.comment-button');
            const postCard = target.closest('.post-card');
            const postId = postCard?.dataset.postId;

            if (commentLink) {
                e.preventDefault();
                window.top.location.hash = commentLink.getAttribute('href').substring(1);
                return;
            }
            if (!currentUser) return; // Seuls les utilisateurs connect√©s peuvent interagir

            if (reactionItem) {
                const reaction = reactionItem.dataset.reaction;
                if (reactionItem.classList.contains('user-reacted')) {
                    await supabaseClient.from('reactions').delete().match({ post_id: postId, user_id: currentUser.id });
                } else {
                    await supabaseClient.from('reactions').upsert({ post_id: postId, user_id: currentUser.id, reaction_type: reaction });
                }
            } else if (menuButton) {
                menuButton.nextElementSibling.classList.toggle('visible');
             } else if (actionButton) {
                const action = actionButton.dataset.action;
                if (action === 'edit') {
                    window.top.location.hash = `#publier?edit=${postId}`;
                } else if (action === 'delete') {
                    if (confirm('Voulez-vous vraiment supprimer cet article ?')) {
                        const { error } = await supabaseClient.from('posts').delete().eq('id', postId);
                        if (error) {
                            alert("Action non autoris√©e. Votre r√¥le ne permet pas cette action.");
                            console.error(error);
                        }
                    }
                }
            }
        });
        
        await fetchPosts();
        supabaseClient.channel('db-changes-realtime')
            .on('postgres_changes', { event: '*', schema: 'public' }, () => {
                console.log("Changement d√©tect√©, mise √† jour du fil d'actualit√©.");
                fetchPosts(searchInput.value.trim());
            })
            .subscribe();
    </script>
</body>
</html>
