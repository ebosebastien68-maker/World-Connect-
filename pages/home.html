<style>
    /* Utilisation de variables CSS pour une maintenance facile du design */
    :root {
        --border-color-home: #e9ebee;
        --card-background-home: #fff;
        --text-color-home: #1c1e21;
        --text-color-secondary-home: #65676b;
        --primary-color-home: #007bff;
        --hover-background-home: #f0f2f5;
    }

    .home-container { max-width: 750px; margin: auto; padding: 0 10px; }
    .post-card {
        background: var(--bg-content, var(--card-background-home));
        border-radius: 12px;
        border: 1px solid var(--border-color, var(--border-color-home));
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        margin-bottom: 30px;
        overflow: hidden;
        color: var(--text-primary, var(--text-color-home));
    }

    /* --- En-tête de l'article --- */
    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
    }
    .post-author-info { display: flex; flex-direction: column; }
    .post-author { font-weight: 600; font-size: 1.1em; }
    .post-timestamp { font-size: 0.85em; color: var(--text-secondary, var(--text-color-secondary-home)); }
    
    /* --- Contenu de l'article --- */
    .post-content { padding: 0 20px 20px 20px; line-height: 1.6; }
    .post-content p { margin: 0; }
    .post-media-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 5px; margin-top: 15px; }
    .post-media-grid img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

    /* --- Liens (WhatsApp, Acheter, etc.) --- */
    .post-links-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .post-link-btn {
        background-color: var(--hover-background, var(--hover-background-home)); color: var(--text-primary, var(--text-color-home));
        text-decoration: none; padding: 8px 15px; border-radius: 20px;
        font-size: 0.9em; font-weight: 500;
        transition: all 0.2s ease;
    }
    .post-link-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .whatsapp-btn { background-color: #25D366; color: white; }
    .buy-btn { background-color: var(--accent-color, var(--primary-color-home)); color: white; }

    /* --- Section des interactions (Réactions, Commentaires) --- */
    .post-interactions { border-top: 1px solid var(--border-color, var(--border-color-home)); padding: 5px 20px 15px 20px; }
    .post-actions { display: flex; justify-content: space-around; padding: 10px 0; }
    .action-btn {
        background: none; border: none; cursor: pointer; font-size: 24px;
        color: var(--text-secondary, var(--text-color-secondary-home)); padding: 8px; border-radius: 8px;
        transition: background-color 0.2s, color 0.2s;
    }
    .action-btn:hover { background-color: var(--hover-background, var(--hover-background-home)); color: var(--accent-color, var(--primary-color-home)); }
    .comment-form { display: flex; gap: 10px; margin-top: 10px; }
    .comment-form input {
        flex-grow: 1; background-color: var(--hover-background, var(--hover-background-home));
        border: none; padding: 12px 18px; border-radius: 20px;
        color: var(--text-primary, var(--text-color-home));
    }
    .login-prompt { text-align: center; color: var(--text-secondary, var(--text-color-secondary-home)); padding: 15px 0; }
    .login-prompt a { color: var(--accent-color, var(--primary-color-home)); font-weight: 600; text-decoration: none; }

    /* --- Menu Admin --- */
    .post-menu { position: relative; }
    .post-menu-button { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; color: var(--text-secondary, var(--text-color-secondary-home)); }
    .post-menu-button:hover { background-color: var(--hover-background, var(--hover-background-home)); }
    .post-menu-dropdown { display: none; position: absolute; right: 0; top: 100%; background: var(--bg-content, white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); list-style: none; padding: 8px 0; margin: 5px 0 0 0; width: 160px; z-index: 10; }
    .post-menu-dropdown.visible { display: block; }
    .post-menu-dropdown li button { background: none; border: none; width: 100%; padding: 10px 15px; text-align: left; cursor: pointer; font-size: 14px; color: var(--text-primary, var(--text-color-home)); }
    .post-menu-dropdown li button:hover { background-color: var(--hover-background, var(--hover-background-home)); }
    .delete-action { color: #dc3545; }

    /* --- Messages d'erreur et de chargement --- */
    .loading-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary, var(--text-color-secondary-home));
        font-size: 1.1em;
    }
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--accent-color, var(--primary-color-home));
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .error-alert {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        text-align: center;
    }
    .retry-btn {
        background-color: var(--accent-color, var(--primary-color-home));
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 10px;
    }
    .retry-btn:hover {
        opacity: 0.9;
    }

    /* --- Indicateur de fin de page --- */
    .end-of-feed {
        text-align: center;
        padding: 30px 20px;
        color: var(--text-secondary, var(--text-color-secondary-home));
        font-size: 0.9em;
        border-top: 1px solid var(--border-color, var(--border-color-home));
        margin-top: 20px;
    }

    /* --- Loader pour défilement infini --- */
    .infinite-scroll-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px 20px;
        color: var(--text-secondary, var(--text-color-secondary-home));
    }
</style>

<div class="home-container" id="posts-feed">
    <div class="loading-message">
        <div class="loading-spinner"></div>
        Chargement des publications...
    </div>
</div>

<script>
(async function() {
    const postsFeed = document.getElementById('posts-feed');
    if (!postsFeed) return;

    let currentUserProfile = null;
    let loadTimeout = null;
    
    // Variables pour la pagination et le défilement infini
    let currentPage = 0;
    const postsPerPage = 10;
    let isLoading = false;
    let hasMorePosts = true;
    let allPosts = []; // Cache des posts chargés

    // Récupérer le profil utilisateur si connecté
    if (window.currentUser) {
        try {
            const { data } = await window.supabaseClient
                .from('profiles')
                .select('role')
                .eq('id', window.currentUser.id)
                .single();
            currentUserProfile = data;
        } catch (error) {
            console.warn('Impossible de récupérer le profil utilisateur:', error);
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.round((now - date) / 1000);
        const minutes = Math.round(seconds / 60);
        const hours = Math.round(minutes / 60);
        const days = Math.round(hours / 24);
        if (seconds < 60) return `à l'instant`;
        if (minutes < 60) return `il y a ${minutes} min`;
        if (hours < 24) return `il y a ${hours} h`;
        if (days < 7) return `il y a ${days} j`;
        return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // Fonction d'erreur supprimée selon les nouveaux ajustements

    const fetchPosts = async (page = 0, append = false) => {
        if (isLoading) return;
        isLoading = true;
        
        try {
            // Afficher le loader si c'est un ajout de page
            if (append) {
                const loader = document.createElement('div');
                loader.className = 'infinite-scroll-loader';
                loader.innerHTML = '<div class="loading-spinner"></div>Chargement de plus de publications...';
                loader.id = 'scroll-loader';
                postsFeed.appendChild(loader);
            }

            // Requête paginée avec collecte complète des données
            const from = page * postsPerPage;
            const to = from + postsPerPage - 1;

            const { data: posts, error } = await window.supabaseClient
                .from('posts')
                .select(`
                    id,
                    user_id,
                    content,
                    media_url,
                    buy_link,
                    created_at,
                    profiles:user_id (
                        email,
                        avatar_url,
                        role
                    ),
                    post_images (
                        id,
                        image_url
                    ),
                    post_whatsapp_numbers (
                        id,
                        whatsapp_number
                    ),
                    post_custom_links (
                        id,
                        title,
                        url
                    ),
                    reactions (
                        id,
                        user_id,
                        reaction_type,
                        created_at
                    ),
                    comments (
                        id,
                        user_id,
                        content,
                        created_at,
                        parent_comment_id,
                        profiles:user_id (
                            email,
                            avatar_url
                        )
                    )
                `)
                .order('created_at', { ascending: false })
                .range(from, to);

            // Supprimer le loader de défilement
            const scrollLoader = document.getElementById('scroll-loader');
            if (scrollLoader) {
                scrollLoader.remove();
            }

            // Traitement silencieux des erreurs - pas de messages d'erreur
            if (error) {
                console.warn("Erreur de chargement des posts:", error);
                return;
            }

            // Vérifier s'il y a encore des posts à charger
            hasMorePosts = posts && posts.length === postsPerPage;

            if (append) {
                // Ajouter les nouveaux posts au cache et à l'affichage
                if (posts && posts.length > 0) {
                    allPosts = [...allPosts, ...posts];
                    appendPosts(posts);
                } else if (!hasMorePosts && allPosts.length > 0) {
                    // Afficher un message de fin
                    const endMessage = document.createElement('div');
                    endMessage.className = 'end-of-feed';
                    endMessage.innerHTML = 'Vous avez vu toutes les publications disponibles.';
                    postsFeed.appendChild(endMessage);
                }
            } else {
                // Premier chargement : remplacer tout le contenu
                allPosts = posts || [];
                renderPosts(allPosts);
            }

            currentPage = page;

        } catch (error) {
            const scrollLoader = document.getElementById('scroll-loader');
            if (scrollLoader) scrollLoader.remove();
            
            // Traitement silencieux des erreurs
            console.warn("Erreur lors de la requête:", error);
        } finally {
            isLoading = false;
        }
    };

    const renderPosts = (posts) => {
        if (!posts || posts.length === 0) {
            postsFeed.innerHTML = '<div class="loading-message">Aucune publication à afficher pour le moment.</div>';
            return;
        }

        postsFeed.innerHTML = posts.map(post => generatePostHTML(post)).join('');
    };

    const appendPosts = (posts) => {
        if (!posts || posts.length === 0) return;
        
        const postsHTML = posts.map(post => generatePostHTML(post)).join('');
        postsFeed.insertAdjacentHTML('beforeend', postsHTML);
    };

    const generatePostHTML = (post) => {
        const isAdmin = currentUserProfile && currentUserProfile.role === 'admin';
        const isOwner = window.currentUser && post.user_id === window.currentUser.id;
        const canModify = isAdmin || isOwner;
        
        // Extraction sécurisée des données des tables liées
        const imageUrls = post.post_images?.map(img => img.image_url).filter(url => url) || [];
        const whatsappNumbers = post.post_whatsapp_numbers?.map(wp => wp.whatsapp_number).filter(num => num) || [];
        const customLinks = post.post_custom_links?.filter(link => link.title && link.url) || [];
        
        return `
        <div class="post-card" data-post-id="${post.id}">
            <div class="post-header">
                <div class="post-author-info">
                    <span class="post-author">${post.profiles?.email || 'Utilisateur supprimé'}</span>
                    <small class="post-timestamp">${formatDate(post.created_at)}</small>
                </div>
                ${canModify ? `
                <div class="post-menu">
                    <button class="post-menu-button" data-action="toggle-menu" title="Options">
                        <svg fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                    </button>
                    <ul class="post-menu-dropdown">
                        <li><button data-action="edit">Modifier</button></li>
                        <li><button data-action="delete" class="delete-action">Supprimer</button></li>
                    </ul>
                </div>
                ` : ''}
            </div>
            <div class="post-content">
                ${post.content ? `<p>${post.content}</p>` : ''}
                <div class="post-media-grid">
                    ${imageUrls.map(url => `<img src="${url}" alt="Image" onerror="this.style.display='none'">`).join('')}
                    ${post.media_url ? `<img src="${post.media_url}" alt="Média" onerror="this.style.display='none'">` : ''}
                </div>
                <div class="post-links-container">
                    ${whatsappNumbers.map(num => `<a href="https://wa.me/${num.replace(/\D/g, '')}" target="_blank" class="post-link-btn whatsapp-btn">WhatsApp</a>`).join('')}
                    ${post.buy_link ? `<a href="${post.buy_link}" target="_blank" class="post-link-btn buy-btn">Acheter</a>` : ''}
                    ${customLinks.map(link => `<a href="${link.url}" target="_blank" class="post-link-btn">${link.title}</a>`).join('')}
                </div>
            </div>
            <div class="post-interactions">
            ${window.currentUser ? `
                <div class="post-actions">
                    <button class="action-btn" data-action="react" data-reaction="like" title="J'aime">👍</button>
                    <button class="action-btn" data-action="react" data-reaction="love" title="J'adore">❤️</button>
                    <button class="action-btn" data-action="react" data-reaction="laugh" title="Haha">🤣</button>
                    <button class="action-btn" data-action="react" data-reaction="angry" title="Grrr">😡</button>
                </div>
                <div class="comments-section">
                    <form class="comment-form" data-post-id="${post.id}">
                        <input type="text" placeholder="Ajouter un commentaire..." required>
                        <button type="submit" style="display: none;">Envoyer</button>
                    </form>
                </div>
            ` : `
                <p class="login-prompt"><a href="index.html">Connectez-vous</a> pour réagir ou commenter.</p>
            `}
            </div>
        </div>
        `;
    };

    // Fonction pour recharger complètement les posts
    const reloadAllPosts = async () => {
        currentPage = 0;
        hasMorePosts = true;
        allPosts = [];
        await fetchPosts(0, false);
    };

    // Gestionnaire de défilement infini
    const handleInfiniteScroll = () => {
        // Vérifier si l'utilisateur approche du bas de la page
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Déclencher le chargement quand il reste 500px avant la fin
        if (scrollTop + windowHeight >= documentHeight - 500 && hasMorePosts && !isLoading) {
            fetchPosts(currentPage + 1, true);
        }
    };

    // Débouncer la fonction de scroll pour les performances
    let scrollTimeout;
    const debouncedScroll = () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(handleInfiniteScroll, 100);
    };

    // Ajouter l'écouteur de défilement
    window.addEventListener('scroll', debouncedScroll);

    // Gestionnaire d'événements pour les interactions
    postsFeed.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        
        const action = button.dataset.action;
        const postCard = button.closest('.post-card');
        const postId = postCard ? postCard.dataset.postId : null;

        if (action === 'toggle-menu') {
            // Fermer tous les autres menus
            document.querySelectorAll('.post-menu-dropdown.visible').forEach(menu => {
                if (menu !== button.nextElementSibling) {
                    menu.classList.remove('visible');
                }
            });
            button.nextElementSibling.classList.toggle('visible');
            
        } else if (action === 'edit') {
            window.location.hash = `#publier?edit=${postId}`;
            
        } else if (action === 'delete') {
            if (confirm('Voulez-vous vraiment supprimer cette publication ?')) {
                try {
                    // La suppression en cascade des tables liées sera gérée par les contraintes FK
                    const { error } = await window.supabaseClient
                        .from('posts')
                        .delete()
                        .eq('id', postId);
                        
                    if (error) {
                        console.warn('Erreur lors de la suppression:', error);
                    } else {
                        // Rechargement automatique sans messages d'erreur
                        await reloadAllPosts();
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur de connexion');
                }
            }
            
        } else if (action === 'react') {
            const reaction = button.dataset.reaction;
            try {
                await window.supabaseClient
                    .from('reactions')
                    .upsert([{
                        post_id: postId,
                        user_id: window.currentUser.id,
                        reaction_type: reaction
                    }]);
            } catch (error) {
       
