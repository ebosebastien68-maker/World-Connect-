<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accueil</title>
    <style>
        /* Votre CSS professionnel est conserv√© */
    </style>
</head>
<body>
    <div class="home-container">
        <header class="home-header">
            <svg fill="currentColor" viewBox="0 0 24 24" width="24"><path d="..."></path></svg>
            <input type="text" id="searchInput" placeholder="Rechercher des articles...">
        </header>
        <div id="posts-feed"></div>
    </div>

    <script type="module">
        import { supabaseClient } from '../supabaseClient.js';

        const postsFeed = document.getElementById('posts-feed');
        const searchInput = document.getElementById('searchInput');
        if (!postsFeed || !searchInput) throw new Error("√âl√©ments HTML manquants");

        const { data: { user } } = await supabaseClient.auth.getUser();
        const currentUser = user;
        
        function formatDate(dateString) { /* ... (Fonction date identique) ... */ }

        // --- CORRECTION DE LA REQU√äTE POUR √äTRE CONFORME AU SQL V7 ---
        const fetchPosts = async (searchTerm = '') => {
            let query = supabaseClient
                .from('posts')
                .select(`
                    *,
                    profiles ( email ),
                    post_images ( image_url ),
                    post_whatsapp_numbers ( whatsapp_number ),
                    post_custom_links ( title, url ),
                    reactions ( reaction_type, user_id )
                `)
                .order('created_at', { ascending: false });

            if (searchTerm) {
                query = query.textSearch('content', searchTerm, { type: 'websearch', config: 'french' });
            }

            const { data: posts, error } = await query;
            if (error) { 
                console.error("Erreur d√©taill√©e:", error);
                postsFeed.innerHTML = "<p>Une erreur est survenue lors du chargement des articles.</p>";
                return; 
            }
            renderPosts(posts);
        };

        const renderPosts = (posts) => {
            postsFeed.innerHTML = !posts || posts.length === 0
                ? '<p style="text-align:center; padding: 20px;">Aucun article trouv√©.</p>'
                : posts.map(post => generatePostHTML(post)).join('');
        };

        const generatePostHTML = (post) => {
            // --- CORRECTION : On ne v√©rifie plus le r√¥le, seulement si l'utilisateur est connect√© ---
            const showAdminMenu = currentUser; // Le menu s'affiche pour tout utilisateur connect√©
            const authorEmail = post.profiles?.email || 'Anonyme';
            const avatarInitial = authorEmail.charAt(0).toUpperCase();

            const reactionsCount = (post.reactions || []).reduce((acc, r) => { acc[r.reaction_type] = (acc[r.reaction_type] || 0) + 1; return acc; }, {});
            const userReaction = currentUser ? (post.reactions || []).find(r => r.user_id === currentUser.id)?.reaction_type : null;
            
            return `
            <div class="post-card" data-post-id="${post.id}">
                <div class="post-header">
                    <div class="post-author-info">
                        <div class="avatar">${avatarInitial}</div>
                        <div>
                            <span class="post-author">${authorEmail}</span>
                            <small class="post-timestamp">${formatDate(post.created_at)}</small>
                        </div>
                    </div>
                    ${showAdminMenu ? `
                    <div class="post-menu">
                        <button class="post-menu-button" data-action="toggle-menu" title="Options">
                           <svg fill="currentColor" viewBox="0 0 24 24" width="24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                        </button>
                        <ul class="post-menu-dropdown">
                            <li><button data-action="edit">Modifier</button></li>
                            <li><button data-action="delete" class="delete-action">Supprimer</button></li>
                        </ul>
                    </div>` : ''}
                </div>

                <div class="post-content">
                    <p>${post.content || ''}</p>
                    <div class="post-media-grid">
                        ${(post.media_url ? [`<img src="${post.media_url}" alt="M√©dia">`] : []).concat(
                            (post.post_images || []).map(img => `<img src="${img.image_url}" alt="Image">`)
                        ).join('')}
                    </div>
                    <div class="post-links-container">
                         ${(post.post_whatsapp_numbers || []).map(wp => `<a href="https://wa.me/${wp.whatsapp_number}" target="_blank" class="post-link-btn whatsapp-btn">WhatsApp</a>`).join('')}
                        ${post.buy_link ? `<a href="${post.buy_link}" target="_blank" class="post-link-btn buy-btn">Acheter</a>` : ''}
                        ${(post.post_custom_links || []).map(link => `<a href="${link.url}" target="_blank" class="post-link-btn">${link.title}</a>`).join('')}
                    </div>
                </div>

                <div class="post-reactions-bar">
                    ${['üëç', '‚ù§Ô∏è', 'ü§£', 'üò°'].map(emoji => `
                        <div class="reaction-item ${userReaction === emoji ? 'user-reacted' : ''}" data-action="react" data-reaction="${emoji}">
                            <span>${emoji}</span>
                            <span>${reactionsCount[emoji] || 0}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="post-footer">
                    <a href="#commentaire?post=${post.id}" class="comment-button">Commentaires</a>
                </div>
            </div>`;
        };
        
        // ... (le reste du script est identique)
        
    </script>
</body>
</html>
