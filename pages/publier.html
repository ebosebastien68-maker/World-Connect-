<style>
    /* Votre CSS professionnel et complet est conservé à 100% */
    .publisher-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
    }
    /* ... Le reste de votre CSS ... */
</style>

<div class="publisher-grid">
    <div class="main-column">
        <form id="publishForm">
            </form>
    </div>
    <div class="sidebar-column">
        </div>
</div>
<div id="textEditorModal" class="text-editor-modal">
    </div>


<script type="module">
    // --- NOUVELLE STRUCTURE : Import direct de la connexion ---
    import { supabaseClient } from '../supabaseClient.js';

    // Le script récupère lui-même l'utilisateur actuel
    const { data: { user } } = await supabaseClient.auth.getUser();
    const currentUser = user;

    if (!currentUser) {
        document.querySelector('.publisher-grid').innerHTML = '<h2>Vous devez être connecté pour publier.</h2>';
        // Arrêter l'exécution si aucun utilisateur n'est connecté
        throw new Error("Utilisateur non connecté");
    }

    // Le reste de votre script, qui était déjà parfaitement fonctionnel, est conservé
    let postDraft = { content: "", localFile: null, imageUrls: Array(5).fill(""), whatsappNumbers: Array(3).fill(""), buyLink: "", customLinks: Array(7).fill({ title: "", url: "" }) };
    let editMode = false;
    let postIdToUpdate = null;

    const form = document.getElementById('publishForm');
    const publishButton = document.getElementById('publishButton');
    const publishStatus = document.getElementById('publishStatus');
    // ... (déclaration de tous vos autres éléments DOM)
    
    function createInputs(containerId, count, placeholders) {
        // ... (votre fonction createInputs est conservée)
    }
    createInputs('imageUrlsContainer', 5, ['URL de l\'image']);
    createInputs('whatsappContainer', 3, ['Numéro WhatsApp (ex: 229...)']);
    createInputs('customLinksContainer', 7, ['URL du lien', 'Titre du bouton']);

    // ... (tous vos event listeners pour le modal, les inputs, etc. sont conservés)

    // Logique pour le mode édition
    const params = new URLSearchParams(window.location.hash.split('?')[1]);
    postIdToUpdate = params.get('edit');

    if (postIdToUpdate) {
        editMode = true;
        publishButton.textContent = "Mettre à jour l'Article";
        
        // La récupération des données pour le mode édition est conservée
        const { data: postToEdit } = await supabaseClient.from('posts').select('*').eq('id', postIdToUpdate).single();
        const { data: postImages } = await supabaseClient.from('post_images').select('image_url').eq('post_id', postIdToUpdate);
        const { data: postWhatsApp } = await supabaseClient.from('post_whatsapp_numbers').select('whatsapp_number').eq('post_id', postIdToUpdate);
        const { data: postLinks } = await supabaseClient.from('post_custom_links').select('title, url').eq('post_id', postIdToUpdate);
        
        if (postToEdit) {
            // ... (logique de remplissage du formulaire conservée)
        }
    }

    function updateUIFromDraft() {
        // ... (votre fonction updateUIFromDraft est conservée)
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        // ... (toute votre logique de soumission, d'upload, de création et de mise à jour est conservée)
        
        // Exemple d'une ligne de code à l'intérieur qui est maintenant correcte :
        // const { data: newPost, error: insertError } = await supabaseClient.from('posts').insert(finalData).select('id').single();
    });

</script>
