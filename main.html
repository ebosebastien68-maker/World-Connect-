<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Web - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Votre CSS professionnel est conserv√© √† 100% */
        :root {
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --transition-speed: 0.3s;
            /* ...etc... */
        }
        /* ... Le reste de votre CSS est ici ... */
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <div class="navbar-title">üåç World Web</div>
            <h1 class="page-title" id="page-title">Accueil</h1>
        </div>
        <div class="navbar-right">
            <div class="nav-links">
                <div class="nav-link active" data-page="home" title="Accueil">...</div>
                <div class="nav-link" data-page="menu" title="Menu">...</div>
            </div>
            <button class="theme-toggle" id="themeToggle" title="Changer de th√®me">...</button>
        </div>
    </nav>
    <main id="app-content">
        <div class="loader">
            <div class="loader-spinner"></div>
            <p>Chargement de l'application...</p>
        </div>
    </main>

    <script type="module">
        // --- NOUVELLE STRUCTURE : La connexion est import√©e ---
        import { supabaseClient } from './supabaseClient.js';

        // On rend le client accessible globalement pour les mini-fichiers
        window.supabaseClient = supabaseClient;
        window.currentUser = null;
        window.currentUserProfile = null;
        
        // Le reste de votre script, qui √©tait d√©j√† correct, est conserv√©
        const appContent = document.getElementById('app-content');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageTitle = document.getElementById('page-title');
        const pagesToPreload = ['home', 'messages', 'groupes', 'publier', 'notifications', 'menu'];

        const showPage = (pageName) => {
            document.querySelectorAll('.preloaded-page').forEach(p => p.style.display = 'none');
            const activePage = document.getElementById(`page-${pageName}`);
            if (activePage) {
                activePage.style.display = 'block';
                activePage.classList.add('page-fade-in');
            }

            navLinks.forEach(link => {
                const isActive = link.dataset.page === pageName;
                link.classList.toggle('active', isActive);
                if(isActive) pageTitle.textContent = link.title;
            });
            
            const initFunctionName = `initialize${pageName.charAt(0).toUpperCase() + pageName.slice(1)}Page`;
            if (typeof window[initFunctionName] === 'function') {
                const pageElement = document.getElementById(`page-${pageName}`);
                if (pageElement && !pageElement.dataset.initialized) {
                    window[initFunctionName]();
                    pageElement.dataset.initialized = 'true';
                }
            }
        };
        
        const preloadAllPages = async () => {
             appContent.innerHTML = '';
            for (const pageName of pagesToPreload) {
                try {
                    const response = await fetch(`./pages/${pageName}.html`);
                    if (!response.ok) throw new Error(`Page non trouv√©e: ${pageName}`);
                    const html = await response.text();
                    const pageContainer = document.createElement('div');
                    pageContainer.id = `page-${pageName}`;
                    pageContainer.classList.add('preloaded-page');
                    pageContainer.innerHTML = html;
                    appContent.appendChild(pageContainer);
                } catch(e) { console.error(e); }
            }
        };

        const initializeApp = async () => {
            await preloadAllPages();
            document.querySelectorAll('.preloaded-page script').forEach(script => {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript).remove();
            });
            showPage('home');
        };
        
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-theme', savedTheme === 'dark');
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { 
                window.location.href = 'index.html';
                return; 
            }
            window.currentUser = session.user;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', window.currentUser.id).single();
            window.currentUserProfile = profile;
            await initializeApp();
        });

        document.querySelector('.nav-links').addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                const page = navLink.dataset.page;
                showPage(page);
            }
        });
    </script>
</body>
</html>
