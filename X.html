<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Contr√¥le des R√©actions Simul√©es - BULK</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Segoe UI, Tahoma, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
.container{max-width:1100px;margin:0 auto}
.header{background:#fff;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
.header h1{color:#667eea;font-size:24px}
.bulk-section{background:#fff;border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
.input-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.input-row > *{flex:1;min-width:200px}
select,input,textarea{width:100%;padding:10px;border:2px solid #e6e6e6;border-radius:10px;font-size:14px}
.reactions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:12px}
.reaction-card{text-align:center;padding:12px;border-radius:10px;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%)}
.execute-btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:10px;border:none;background:linear-gradient(135deg,#11998e,#38ef7d);color:#fff;font-weight:700;cursor:pointer}
.execute-btn:disabled{background:#ccc;cursor:not-allowed}
.result{display:none;margin-top:14px;padding:12px;border-radius:8px}
.result.show{display:block}
.result.success{background:linear-gradient(135deg,#d4edda,#c3e6cb);border-left:5px solid #28a745}
.result.error{background:linear-gradient(135deg,#f8d7da,#f5c6cb);border-left:5px solid #dc3545}
.detail-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee}
.loading-spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.mode-indicator{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;margin-left:10px}
.mode-article{background:#e3f2fd;color:#1976d2}
.mode-comment{background:#fff3e0;color:#f57c00}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üöÄ Contr√¥le des R√©actions Simul√©es ‚Äî BULK</h1>
    <p style="color:#666;font-size:13px;margin-top:6px">
      Nouveau format: <strong>target.type</strong> (article ou comment) + <strong>target.id</strong> (UUID)
    </p>
  </div>

  <div class="bulk-section">
    <div style="margin-bottom:12px">
      <label for="targetType">Type de cible <span id="modeIndicator" class="mode-indicator mode-article">Article</span></label>
      <select id="targetType">
        <option value="article">Article (r√©actions + commentaires)</option>
        <option value="comment">Commentaire (r√©ponses uniquement)</option>
      </select>
    </div>

    <div class="input-row">
      <div>
        <label id="targetLabel" for="targetId">üìù ID de la cible (UUID)</label>
        <input id="targetId" type="text" placeholder="UUID de l'article ou commentaire (ex: abc123-...)" />
      </div>
      <div style="max-width:220px">
        <label for="clearBtn">Actions</label>
        <button id="clearBtn" class="execute-btn" style="background:#f0f0f0;color:#333">Effacer</button>
      </div>
    </div>

    <div id="reactionsSection">
      <h3 style="margin-bottom:10px;color:#667eea">R√©actions (pour articles uniquement)</h3>
      <div class="reactions-grid">
        <div class="reaction-card">
          <div style="font-size:28px">üëç</div>
          <label for="likeNumber">Like</label>
          <input id="likeNumber" type="number" value="0" min="0" />
        </div>
        <div class="reaction-card">
          <div style="font-size:28px">‚ù§Ô∏è</div>
          <label for="loveNumber">Love</label>
          <input id="loveNumber" type="number" value="0" min="0" />
        </div>
        <div class="reaction-card">
          <div style="font-size:28px">üòÜ</div>
          <label for="rireNumber">Rire</label>
          <input id="rireNumber" type="number" value="0" min="0" />
        </div>
        <div class="reaction-card">
          <div style="font-size:28px">üò°</div>
          <label for="colereNumber">Col√®re</label>
          <input id="colereNumber" type="number" value="0" min="0" />
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div id="commentsSection">
        <label for="commentsArea">üí¨ Commentaires (ligne par commentaire) ‚Äî pour articles</label>
        <textarea id="commentsArea" rows="5" placeholder="Un commentaire par ligne..."></textarea>
      </div>
      <div id="repliesSection">
        <label for="repliesArea">‚Ü©Ô∏è R√©ponses (ligne par r√©ponse) ‚Äî pour commentaires</label>
        <textarea id="repliesArea" rows="5" placeholder="Une r√©ponse par ligne..."></textarea>
      </div>
    </div>

    <div style="margin-top:8px">
      <button id="executeBtn" class="execute-btn">
        <span id="btnText">üöÄ EX√âCUTER</span>
        <span id="btnLoader" style="display:none;margin-left:6px" class="loading-spinner"></span>
      </button>
    </div>

    <div id="result" class="result" role="status" aria-live="polite" style="margin-top:14px"></div>
  </div>
</div>

<script>
/*
  Frontend mis √† jour pour correspondre √† la nouvelle structure backend:
  {
    target: { type: "article" | "comment", id: "UUID" },
    reactions: { like: n, love: n, rire: n, colere: n },  // si target.type === "article"
    comments: ["texte1", "texte2", ...],                   // si target.type === "article"
    replies: ["texte1", "texte2", ...]                     // si target.type === "comment"
  }
*/

const EDGE_FUNCTION_URL = 'https://odkbkloukpzvwxaomkfe.supabase.co/functions/v1/manage-interactions';

// UI refs
const targetType = document.getElementById('targetType');
const targetIdInput = document.getElementById('targetId');
const targetLabel = document.getElementById('targetLabel');
const modeIndicator = document.getElementById('modeIndicator');
const likeNumber = document.getElementById('likeNumber');
const loveNumber = document.getElementById('loveNumber');
const rireNumber = document.getElementById('rireNumber');
const colereNumber = document.getElementById('colereNumber');
const commentsArea = document.getElementById('commentsArea');
const repliesArea = document.getElementById('repliesArea');
const reactionsSection = document.getElementById('reactionsSection');
const commentsSection = document.getElementById('commentsSection');
const repliesSection = document.getElementById('repliesSection');
const executeBtn = document.getElementById('executeBtn');
const btnText = document.getElementById('btnText');
const btnLoader = document.getElementById('btnLoader');
const clearBtn = document.getElementById('clearBtn');
const result = document.getElementById('result');

// Update UI based on target type
function updateUIForTargetType() {
  const type = targetType.value;
  if (type === 'article') {
    modeIndicator.textContent = 'Article';
    modeIndicator.className = 'mode-indicator mode-article';
    targetLabel.textContent = 'üìù Article ID (UUID)';
    reactionsSection.style.display = 'block';
    commentsSection.style.display = 'block';
    repliesSection.style.opacity = '0.4';
    repliesArea.placeholder = 'Non utilis√© pour les articles';
  } else {
    modeIndicator.textContent = 'Commentaire';
    modeIndicator.className = 'mode-indicator mode-comment';
    targetLabel.textContent = 'üí¨ Commentaire/Session ID (UUID)';
    reactionsSection.style.display = 'none';
    commentsSection.style.opacity = '0.4';
    commentsArea.placeholder = 'Non utilis√© pour les commentaires';
    repliesSection.style.opacity = '1';
    repliesArea.placeholder = 'Une r√©ponse par ligne...';
  }
}

targetType.addEventListener('change', updateUIForTargetType);
updateUIForTargetType();

function resetResult() {
  result.className = 'result';
  result.innerHTML = '';
}

function showResultBox(success, payload) {
  result.className = 'result show ' + (success ? 'success' : 'error');
  if (success) {
    const r = payload || {};
    const sr = r.success_rate ?? Math.round(((r.total_added||0) / (r.total_requested||1)) * 100);
    result.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong style="font-size:16px">${r.total_added || 0}/${r.total_requested || 0} √©l√©ments ajout√©s</strong>
          <div style="color:#666;font-size:13px;margin-top:6px">Taux de succ√®s: ${sr}%</div>
        </div>
        <div style="font-size:22px">${sr===100?'üéâ':'‚úÖ'}</div>
      </div>
      <div style="margin-top:10px;background:#fff;padding:8px;border-radius:6px">
        <div class="detail-row"><div class="label">üëç Likes</div><div class="value">${r.added?.like ?? 0}</div></div>
        <div class="detail-row"><div class="label">‚ù§Ô∏è Loves</div><div class="value">${r.added?.love ?? 0}</div></div>
        <div class="detail-row"><div class="label">üòÜ Rires</div><div class="value">${r.added?.rire ?? 0}</div></div>
        <div class="detail-row"><div class="label">üò° Col√®res</div><div class="value">${r.added?.colere ?? 0}</div></div>
        <div class="detail-row"><div class="label">üí¨ Commentaires</div><div class="value">${r.added?.comments ?? 0}</div></div>
        <div class="detail-row"><div class="label">‚Ü©Ô∏è R√©ponses</div><div class="value">${r.added?.replies ?? 0}</div></div>
        <div class="detail-row"><div class="label">‚è±Ô∏è Dur√©e</div><div class="value">${r.duration_ms ?? '‚Äî'} ms</div></div>
      </div>
      ${r.target ? `<div style="margin-top:8px;font-size:12px;color:#666">Cible: ${r.target.type} - ${r.target.id.substring(0,8)}...</div>` : ''}
    `;
  } else {
    result.innerHTML = `
      <div style="font-weight:700;font-size:16px;margin-bottom:8px">‚ùå Erreur</div>
      <div style="color:#721c24;background:#fff;padding:10px;border-radius:6px;font-family:monospace;font-size:13px">
        ${(payload?.error ?? 'Erreur inconnue').replace(/\n/g, '<br>')}
      </div>
    `;
  }
}

// Clear inputs
clearBtn.addEventListener('click', () => {
  targetIdInput.value = '';
  likeNumber.value = 0;
  loveNumber.value = 0;
  rireNumber.value = 0;
  colereNumber.value = 0;
  commentsArea.value = '';
  repliesArea.value = '';
  resetResult();
});

// Build and send payload according to new backend structure
executeBtn.addEventListener('click', async () => {
  resetResult();
  const targetId = targetIdInput.value.trim();
  if (!targetId) {
    alert('Veuillez saisir un ID cible (article ou commentaire)');
    return;
  }

  const type = targetType.value; // "article" or "comment"
  
  // Build payload with new structure
  const payload = {
    target: {
      type: type,
      id: targetId
    }
  };

  if (type === 'article') {
    // Add reactions if any
    const reactions = {
      like: Number(likeNumber.value) || 0,
      love: Number(loveNumber.value) || 0,
      rire: Number(rireNumber.value) || 0,
      colere: Number(colereNumber.value) || 0
    };
    
    // Only add reactions if at least one is > 0
    if (Object.values(reactions).some(v => v > 0)) {
      payload.reactions = reactions;
    }

    // Add comments if any
    const comments = commentsArea.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (comments.length > 0) {
      payload.comments = comments;
    }
  } else {
    // type === "comment" => add replies
    const replies = repliesArea.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (replies.length === 0) {
      alert('Pour un commentaire, vous devez ajouter au moins une r√©ponse.');
      return;
    }
    payload.replies = replies;
  }

  // Validate that we have something to insert
  const hasReactions = payload.reactions && Object.values(payload.reactions).some(v => v > 0);
  const hasComments = payload.comments && payload.comments.length > 0;
  const hasReplies = payload.replies && payload.replies.length > 0;

  if (!hasReactions && !hasComments && !hasReplies) {
    alert('Rien √† ins√©rer: ajoutez des r√©actions, commentaires ou r√©ponses.');
    return;
  }

  // UI lock
  executeBtn.disabled = true;
  btnText.style.display = 'none';
  btnLoader.style.display = 'inline-block';

  try {
    const res = await fetch(EDGE_FUNCTION_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
        // Add 'Authorization' header if needed: 'Bearer YOUR_TOKEN'
      },
      body: JSON.stringify(payload)
    });

    const status = res.status;
    let json;
    try {
      json = await res.json();
    } catch(e) {
      json = null;
    }

    if (status === 404) {
      showResultBox(false, {
        error: 'Fonction introuvable (404).\nV√©rifiez le nom/route "manage-interactions".'
      });
    } else if (status >= 500) {
      const errMsg = json?.error || `Erreur serveur (${status})`;
      showResultBox(false, { error: errMsg });
    } else if (!json) {
      showResultBox(false, {
        error: 'R√©ponse invalide du serveur (non JSON).'
      });
    } else if (json.success) {
      showResultBox(true, json);
    } else {
      showResultBox(false, json);
    }
  } catch (err) {
    console.error('Erreur r√©seau:', err);
    showResultBox(false, {
      error: `Erreur r√©seau: ${err.message || String(err)}\n\nV√©rifiez que l'URL de la fonction est correcte et que CORS est configur√©.`
    });
  } finally {
    executeBtn.disabled = false;
    btnText.style.display = 'inline';
    btnLoader.style.display = 'none';
  }
});
</script>
</body>
          </html>
