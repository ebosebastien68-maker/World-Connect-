<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contr√¥le des R√©actions Simul√©es - BULK</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .header p { color: #666; font-size: 14px; }
        .badge { display: inline-block; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-left: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .bulk-section { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .bulk-header { text-align: center; margin-bottom: 20px; }
        .bulk-header h2 { color: #667eea; font-size: 28px; margin-bottom: 10px; }
        .input-row { display:flex; gap:16px; margin-bottom:18px; flex-wrap:wrap; align-items:center; }
        label { color:#333; font-weight:600; font-size:14px; display:block; margin-bottom:6px; }
        select, input[type="text"], input[type="number"], textarea {
            padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; font-size:16px; width:100%;
        }
        .small { width: 200px; }
        .reactions-inputs { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom: 20px; }
        .reaction-input { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 15px; text-align: center; }
        .reaction-input .icon { font-size:48px; margin-bottom:10px; }
        .reaction-input label { display:block; color:#333; font-weight:600; margin-bottom:10px; font-size:16px; }
        .reaction-input input { width:100%; padding:15px; border:2px solid #e0e0e0; border-radius:10px; font-size:20px; font-weight:700; text-align:center; }
        .execute-btn { width:100%; padding:18px; border:none; border-radius:12px; font-size:18px; font-weight:700; cursor:pointer; background:linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color:white; transition:all .3s; box-shadow:0 10px 30px rgba(17,153,142,.3); display:inline-flex; justify-content:center; gap:10px; align-items:center; }
        .execute-btn:disabled { background:#ccc; cursor:not-allowed; box-shadow:none; transform:none; }
        .result-box { margin-top:20px; padding:20px; border-radius:12px; display:none; }
        .result-box.show { display:block; animation: slideIn .3s ease; }
        .result-box.success { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left:5px solid #28a745; }
        .result-box.error { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-left:5px solid #dc3545; }
        .result-header { display:flex; align-items:center; gap:15px; margin-bottom:10px; }
        .result-icon { font-size:36px; }
        .result-title { font-size:20px; font-weight:700; }
        .result-details { background:white; padding:12px; border-radius:8px; margin-top:8px; }
        .detail-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; }
        .detail-row:last-child { border-bottom:none; }
        .detail-row .label { color:#666; font-weight:600; }
        .detail-row .value { color:#333; font-weight:700; }
        .loading-spinner { display:inline-block; width:16px; height:16px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:white; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity:0; transform: translateY(-8px); } to { opacity:1; transform: translateY(0); } }
        @media (max-width:768px) { .reactions-inputs { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Contr√¥le des R√©actions Simul√©es <span class="badge">‚ö° MODE BULK</span></h1>
            <p>Ajoutez des r√©actions, commentaires et r√©ponses en masse ‚Äî choisissez la cible (article ou commentaire).</p>
        </div>

        <div class="bulk-section">
            <div class="bulk-header">
                <h2>‚ö° Ajout Instantan√© d'Interactions</h2>
                <p>Remplis la cible puis les √©l√©ments √† ins√©rer, puis clique EX√âCUTER.</p>
            </div>

            <!-- Target row -->
            <div class="input-row" style="margin-bottom:18px;">
                <div style="flex:1; min-width:220px;">
                    <label for="targetType">Cible</label>
                    <select id="targetType">
                        <option value="article">Article (article_id)</option>
                        <option value="comment">Commentaire / Session (session_id)</option>
                    </select>
                </div>

                <div style="flex:2; min-width:260px;">
                    <label id="targetLabel" for="targetId">üìù Article ID / Session ID</label>
                    <input type="text" id="targetId" placeholder="ex: abc123-def456-ghi789 (UUID ou identifiant)">
                </div>

                <div style="width:160px;">
                    <label for="previewFetch">Afficher counts</label>
                    <button id="fetchCountsBtn" class="execute-btn" style="padding:10px; font-size:14px; background:linear-gradient(135deg,#667eea,#764ba2);">Rafra√Æchir</button>
                </div>
            </div>

            <!-- Reactions -->
            <div class="reactions-inputs">
                <div class="reaction-input">
                    <div class="icon">üëç</div>
                    <label for="likeNumber">Like</label>
                    <input type="number" id="likeNumber" value="0" min="0" max="100000" />
                    <div class="current" id="likeCurrentContainer" style="display:none;">Actuellement: <strong id="likeCount">0</strong></div>
                </div>

                <div class="reaction-input">
                    <div class="icon">‚ù§Ô∏è</div>
                    <label for="loveNumber">Love</label>
                    <input type="number" id="loveNumber" value="0" min="0" max="100000" />
                    <div class="current" id="loveCurrentContainer" style="display:none;">Actuellement: <strong id="loveCount">0</strong></div>
                </div>

                <div class="reaction-input">
                    <div class="icon">üòÜ</div>
                    <label for="rireNumber">Rire</label>
                    <input type="number" id="rireNumber" value="0" min="0" max="100000" />
                    <div class="current" id="rireCurrentContainer" style="display:none;">Actuellement: <strong id="rireCount">0</strong></div>
                </div>

                <div class="reaction-input">
                    <div class="icon">üò°</div>
                    <label for="colereNumber">Col√®re</label>
                    <input type="number" id="colereNumber" value="0" min="0" max="100000" />
                    <div class="current" id="colereCurrentContainer" style="display:none;">Actuellement: <strong id="colereCount">0</strong></div>
                </div>
            </div>

            <!-- Comments / Replies -->
            <div style="margin-bottom:16px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                    <div>
                        <label for="commentsArea">Commentaires (ligne par commentaire) ‚Äî s'appliquent si cible = Article</label>
                        <textarea id="commentsArea" rows="6" placeholder="Ex: Super article !&#10;Tr√®s utile, merci !"></textarea>
                    </div>
                    <div>
                        <label for="repliesArea">R√©ponses (ligne par r√©ponse) ‚Äî s'appliquent si cible = Comment</label>
                        <textarea id="repliesArea" rows="6" placeholder="Ex: Merci pour le partage !&#10;Bonne id√©e !"></textarea>
                    </div>
                </div>
            </div>

            <div style="margin-top:10px;">
                <button id="executeBtn" class="execute-btn">
                    <span id="executeBtnText">üöÄ EX√âCUTER TOUT (INSTANTAN√â)</span>
                    <span id="executeBtnLoader" style="display:none;"><span class="loading-spinner"></span></span>
                </button>
            </div>

            <div class="result-box" id="resultBox">
                <div class="result-header">
                    <div class="result-icon" id="resultIcon"></div>
                    <div>
                        <div class="result-title" id="resultTitle"></div>
                        <div id="resultSubtitle" style="color:#666; font-size:13px; margin-top:6px;"></div>
                    </div>
                </div>
                <div class="result-details" id="resultDetails"></div>
            </div>
        </div>
    </div>

<script>
    // --- CONFIG: UTILISE TON ENDPOINT FOURNI ICI ---
    const EDGE_FUNCTION_URL = 'https://odkbkloukpzvwxaomkfe.supabase.co/functions/v1/manage-interactions';

    // Utility: show result box
    function showResult(success, payload) {
        const box = document.getElementById('resultBox');
        box.className = 'result-box ' + (success ? 'success' : 'error') + ' show';
        document.getElementById('resultIcon').textContent = success ? '‚úÖ' : '‚ùå';
        document.getElementById('resultTitle').textContent = success ? 'Succ√®s !' : '√âchec';
        if (success) {
            const resp = payload;
            const successRate = resp.success_rate ?? 100;
            const emoji = successRate === 100 ? 'üéâ' : successRate >= 75 ? '‚úÖ' : '‚ö†Ô∏è';
            document.getElementById('resultSubtitle').textContent = `${resp.total_added}/${resp.total_requested} √©l√©ments ajout√©s (${successRate}%) ${emoji}`;

            const detailsHTML = `
                <div class="detail-row"><span class="label">üëç Likes ajout√©s</span><span class="value">${resp.added.like ?? 0}</span></div>
                <div class="detail-row"><span class="label">‚ù§Ô∏è Loves ajout√©s</span><span class="value">${resp.added.love ?? 0}</span></div>
                <div class="detail-row"><span class="label">üòÜ Rires ajout√©s</span><span class="value">${resp.added.rire ?? 0}</span></div>
                <div class="detail-row"><span class="label">üò° Col√®res ajout√©es</span><span class="value">${resp.added.colere ?? 0}</span></div>
                <div class="detail-row"><span class="label">üí¨ Commentaires ajout√©s</span><span class="value">${resp.added.comments ?? 0}</span></div>
                <div class="detail-row"><span class="label">‚Ü©Ô∏è R√©ponses ajout√©es</span><span class="value">${resp.added.replies ?? 0}</span></div>
                <div class="detail-row"><span class="label">üìä Taux de succ√®s</span><span class="value">${successRate}%</span></div>
                <div class="detail-row"><span class="label">‚è±Ô∏è Dur√©e</span><span class="value">${resp.duration_ms ?? '‚Äî'} ms</span></div>
            `;
            document.getElementById('resultDetails').innerHTML = detailsHTML;
        } else {
            document.getElementById('resultSubtitle').textContent = payload?.error || 'Une erreur est survenue';
            document.getElementById('resultDetails').innerHTML = `<div style="color:#721c24; padding:10px;"><strong>D√©tails:</strong> ${payload?.error || 'Erreur inconnue'}</div>`;
        }
    }

    // Simple alert wrapper (peut √™tre remplac√©)
    function showAlert(msg) {
        alert(msg);
    }

    // Update target label when type changes
    const targetTypeSelect = document.getElementById('targetType');
    const targetLabel = document.getElementById('targetLabel');
    targetTypeSelect.addEventListener('change', () => {
        const t = targetTypeSelect.value;
        if (t === 'article') {
            targetLabel.textContent = 'üìù Article ID';
        } else {
            targetLabel.textContent = 'üìù Session / Comment ID (session_id)';
        }
    });

    // Fetch current counts (optional): tries to call the function with a special action 'fetch_counts'
    document.getElementById('fetchCountsBtn').addEventListener('click', async () => {
        const targetId = document.getElementById('targetId').value.trim();
        const type = document.getElementById('targetType').value;
        if (!targetId) { showAlert('Veuillez saisir l\'ID cible pour r√©cup√©rer les counts'); return; }

        // UI
        const btn = document.getElementById('fetchCountsBtn');
        btn.disabled = true;
        btn.textContent = 'Chargement...';

        try {
            const payload = { action: 'fetch_counts', target: { type, id: targetId } };
            const res = await fetch(EDGE_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (json && json.success && json.counts) {
                // montrer counts s'ils existent
                const counts = json.counts;
                // update current containers
                const mapping = { like: 'likeCount', love: 'loveCount', rire: 'rireCount', colere: 'colereCount' };
                Object.keys(mapping).forEach(k => {
                    const el = document.getElementById(mapping[k]);
                    const cont = document.getElementById(k + 'CurrentContainer');
                    if (el && cont) {
                        el.textContent = counts[k] ?? 0;
                        cont.style.display = 'block';
                    }
                });
                showResult(true, { total_added: 0, total_requested:0, success_rate:100, added: counts, duration_ms: json.duration_ms ?? 0 });
            } else {
                showAlert(json?.error || 'Impossible de r√©cup√©rer les counts');
            }
        } catch (err) {
            console.error(err);
            showAlert('Erreur r√©seau lors de la r√©cup√©ration des counts');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Rafra√Æchir';
        }
    });

    // Execute bulk action
    document.getElementById('executeBtn').addEventListener('click', async () => {
        const targetType = document.getElementById('targetType').value;
        const targetId = document.getElementById('targetId').value.trim();
        if (!targetId) { showAlert('Veuillez saisir un ID cible (article ou session)'); return; }

        // Reactions
        const like = parseInt(document.getElementById('likeNumber').value) || 0;
        const love = parseInt(document.getElementById('loveNumber').value) || 0;
        const rire = parseInt(document.getElementById('rireNumber').value) || 0;
        const colere = parseInt(document.getElementById('colereNumber').value) || 0;

        // Comments & replies: split by newline and filter empty lines
        const commentsRaw = document.getElementById('commentsArea').value || '';
        const repliesRaw = document.getElementById('repliesArea').value || '';
        const comments = commentsRaw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        const replies = repliesRaw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

        // Build payload according to target
        const payload = { target: { type: targetType, id: targetId } };

        // attach reactions only if target is article
        if (targetType === 'article') {
            payload.reactions = { like, love, rire, colere };
            if (comments.length) payload.comments = comments;
        } else if (targetType === 'comment') {
            // replies apply to comment (session_id)
            if (replies.length) payload.replies = replies;
            // optionally allow reactions on comment? (not in current backend) - not included by default
        }

        // Quick validation: require at least something to insert
        const totalRequested = (payload.reactions ? (payload.reactions.like||0)+(payload.reactions.love||0)+(payload.reactions.rire||0)+(payload.reactions.colere||0) : 0)
            + (payload.comments ? payload.comments.length : 0)
            + (payload.replies ? payload.replies.length : 0);

        if (totalRequested === 0) { showAlert('Veuillez saisir au moins une r√©action, un commentaire ou une r√©ponse √† ins√©rer'); return; }

        // UI lock
        const btn = document.getElementById('executeBtn');
        const btnText = document.getElementById('executeBtnText');
        const btnLoader = document.getElementById('executeBtnLoader');
        btn.disabled = true; btnText.style.display = 'none'; btnLoader.style.display = 'inline-block';

        const start = Date.now();
        try {
            const res = await fetch(EDGE_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const json = await res.json();
            const duration = Date.now() - start;

            if (json && json.success) {
                // ensure duration is present
                json.duration_ms = json.duration_ms || duration;
                showResult(true, json);
            } else {
                showResult(false, json || { error: 'R√©ponse invalide du serveur' });
            }
        } catch (err) {
            console.error(err);
            showResult(false, { error: err.message || String(err) });
        } finally {
            btn.disabled = false; btnText.style.display = 'inline'; btnLoader.style.display = 'none';
        }
    });
</script>
</body>
</html>
