<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Control - Simul√© Simplifi√©</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --text: #1f2937;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text);
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            padding: 40px;
            color: white;
            text-align: center;
        }

        .tabs { display: flex; background: #e5e7eb; padding: 5px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.3s; border-radius: 12px; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .section { display: none; padding: 30px 40px; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }

        .input-group { margin-bottom: 20px; }
        .form-input {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; font-family: monospace; transition: 0.3s;
        }
        .form-input:focus { border-color: var(--primary); outline: none; }
        textarea.form-input { min-height: 200px; line-height: 1.5; resize: vertical; }

        .btn-action {
            width: 100%; padding: 18px; background: linear-gradient(to right, #11998e, #38ef7d); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: transform 0.2s; margin-top: 20px;
        }
        .btn-action:hover { transform: scale(1.02); }
        .btn-action:disabled { background: #d1d5db; transform: none; cursor: not-allowed; }
        
        .helper-text { font-size: 0.85rem; color: #6b7280; background: #f3f4f6; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Search Section specific styles */
        .search-results { max-height: 400px; overflow-y: auto; background: #f9fafb; border-radius: 10px; padding: 15px; }
        .target-item { 
            display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; border-bottom: 1px solid #eee; background: white; border-radius: 8px; 
        }
        .target-item:last-child { border-bottom: none; }
        .target-info { font-size: 14px; }
        .target-info strong { color: var(--primary); font-weight: 700; display: block; margin-bottom: 5px; }
        .target-info span { display: block; color: #6b7280; }
        .copy-btn { padding: 8px 15px; background: #f0f4ff; color: var(--primary); border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üí¨ Contr√¥le des Discussions Simplifi√©</h1>
        <p>G√©n√©ration de Commentaires ou R√©ponses multiples sur un ID unique</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('search')">üîç IDs Cibles</button>
        <button class="tab-btn" onclick="switchTab('simple_discussions')">‚úçÔ∏è Insertion Multiple</button>
    </div>

    <div id="search" class="section active">
        <h2>IDs R√©cents pour Copie</h2>
        <p class="helper-text">
            Cliquez sur "Charger les Cibles" pour obtenir les IDs r√©cents des Articles et Commentaires. Copiez l'ID pour l'utiliser dans l'onglet d'Insertion.
        </p>
        
        <button class="btn-action" id="fetchTargetsBtn" onclick="fetchTargets()">
            Charger les Cibles R√©cents
        </button>

        <div id="searchResults" class="search-results" style="margin-top: 20px;">
            <p style="text-align: center; color: #6b7280;">Aucune cible charg√©e.</p>
        </div>
    </div>

    <div id="simple_discussions" class="section">
        <h2>Insertion de Commentaires/R√©ponses en Vrac</h2>
        
        <div class="input-group">
            <label>UUID de l'Article ou du Commentaire Cible (UUID)</label>
            <input type="text" id="targetIdInput" class="form-input" placeholder="Collez l'ID ici..." />
        </div>

        <div class="helper-text">
            <strong>Format des Messages:</strong> Chaque message doit commencer par un num√©ro entre crochets.
            <br><br>
            <code>[1] Premier commentaire/r√©ponse...</code><br>
            <code>[2] Deuxi√®me message simul√©...</code><br>
            <code>[3] Et ainsi de suite...</code>
        </div>

        <div class="input-group">
            <label>Messages en Vrac</label>
            <textarea id="simpleBulkText" class="form-input" placeholder="[1] J'adore cette approche !
[2] Je ne suis pas d'accord, mais c'est un bon point.
[3] Merci pour l'article/le commentaire !"></textarea>
        </div>

        <button class="btn-action" id="simpleInsertBtn" onclick="sendSimpleBulkText()">
            üöÄ Ins√©rer Tous les Messages
        </button>
    </div>
    
    <div id="statusBox" class="status-box"></div>
</div>

<script>
    const FUNCTION_URL = 'https://odkbkloukpzvwxaomkfe.supabase.co/functions/v1/manage-interactions';

    function switchTab(tabName) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        // Active le bouton correspondant
        document.querySelector(`.tab-btn[onclick*="${tabName}"]`).classList.add('active');
        hideStatus();
    }

    function showStatus(msg, type) {
        const box = document.getElementById('statusBox');
        box.style.display = 'block';
        box.className = 'status-box ' + (type === 'success' ? 'status-success' : 'status-error');
        box.innerHTML = msg;
    }

    function hideStatus() {
        document.getElementById('statusBox').style.display = 'none';
    }

    async function performRequest(payload, actionElementId) {
        const btn = document.getElementById(actionElementId);
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerHTML = `<span class="loading"></span> Traitement...`;
        hideStatus();

        try {
            const res = await fetch(FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            
            if (!data.success) throw new Error(data.error || "Erreur inconnue");

            if (payload.mode === 'simple_bulk_text') {
                 showStatus(`‚úÖ Succ√®s ! ${data.stats.total_messages_inserted} messages ins√©r√©s. Type de cible: ${data.stats.target_type}.`, 'success');
            }

        } catch (e) {
            showStatus("‚ùå Erreur: " + e.message, "error");
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    async function sendSimpleBulkText() {
        const target_id = document.getElementById('targetIdInput').value.trim();
        const raw_text = document.getElementById('simpleBulkText').value;
        
        if (!target_id) return showStatus("Veuillez saisir l'ID Cible (Article ou Commentaire).", "error");
        if (!raw_text.trim()) return showStatus("Veuillez saisir les messages au format [N] Message.", "error");

        performRequest({
            mode: 'simple_bulk_text',
            target_id,
            raw_text
        }, 'simpleInsertBtn');
    }

    // ==========================================
    // LOGIQUE DE R√âCUP√âRATION DES CIBLES
    // ==========================================
    async function fetchTargets() {
        const resultsContainer = document.getElementById('searchResults');
        const btn = document.getElementById('fetchTargetsBtn');
        const originalText = btn.innerText;
        
        btn.disabled = true;
        btn.innerHTML = `<span class="loading"></span> Chargement...`;
        resultsContainer.innerHTML = '<p style="text-align: center; color: #6b7280;">Chargement...</p>';

        try {
            const res = await fetch(FUNCTION_URL + '/targets', { method: 'GET' });
            const data = await res.json();

            if (!data.success || !data.targets || data.targets.length === 0) {
                 resultsContainer.innerHTML = '<p style="text-align: center; color: #6b7280;">Aucune cible trouv√©e ou erreur de fonction.</p>';
                 return;
            }

            const html = data.targets.map(target => `
                <div class="target-item">
                    <div class="target-info">
                        <strong>${target.type}</strong>
                        <span>ID: ${target.id}</span>
                        <span>Aper√ßu: ${target.preview}</span>
                    </div>
                    <button class="copy-btn" onclick="copyId('${target.id}')">Copier ID</button>
                </div>
            `).join('');
            
            resultsContainer.innerHTML = html;

        } catch (e) {
            resultsContainer.innerHTML = `<p style="text-align: center; color: red;">Erreur de connexion: ${e.message}</p>`;
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
    
    function copyId(id) {
        navigator.clipboard.writeText(id).then(() => {
            alert(`ID copi√©: ${id}`);
            // Optionnel: basculer directement vers l'onglet d'insertion
            switchTab('simple_discussions');
            document.getElementById('targetIdInput').value = id;
            document.getElementById('targetIdInput').focus();
        }).catch(err => {
            console.error('Erreur de copie:', err);
            alert('√âchec de la copie. Veuillez copier manuellement: ' + id);
        });
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
        switchTab('search');
    });

</script>
</body>
</html>
